---
import PageLayout from "@/layouts/PageLayout.astro";
import { getCollection } from "astro:content";

const toSlug = (s: string) =>
  (s || "")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");

const cats  = await getCollection("categories");
const posts = await getCollection("blogs");

const catMap = new Map<string, { label: string; slug: string; heroImage?: string; count: number }>();
for (const c of cats) {
  const { label, slug, heroImage } = c.data as { label?: string; slug?: string; heroImage?: string };
  if (!label || !slug) continue;
  catMap.set(slug, { label, slug, heroImage, count: 0 });
}
for (const p of posts) {
  const s = toSlug((p.data.category ?? "").toString());
  if (!s) continue;
  const hit = catMap.get(s);
  if (hit) hit.count += 1;
}
const categories = Array.from(catMap.values()).sort((a, b) =>
  a.label.localeCompare(b.label, "pt-BR")
);
---

<PageLayout title="Tópicos">
  <section class="flex flex-col space-y-3 md:space-y-4">
    <div class="mx-auto w-full md:max-w-[46rem] lg:max-w-[50rem] xl:max-w-[52rem]">
      <p class="text-[12px] font-semibold uppercase tracking-[0.14em] text-secondary-text px-3 md:px-4">
        TÓPICOS
      </p>
    </div>

    <ul class="space-y-3 md:space-y-4">
      {categories.map((cat) => {
        const showThumb = !!cat.heroImage;
        const layoutClass = showThumb
          ? "grid grid-cols-[minmax(0,1fr)_6.5rem] md:grid-cols-[minmax(0,1fr)_6rem] items-center gap-4 p-3 md:p-4"
          : "grid items-center gap-3 p-3 md:p-4";

        return (
          <li class="py-0 first:pt-0">
            <a
              href={`/categories/${cat.slug}`}
              class="group block mx-auto md:max-w-[46rem] lg:max-w-[50rem] xl:max-w-[52rem]
                     w-full rounded bg-card-bg ui-transition hover:bg-surface-bg
                     focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-text"
            >
              <div class={layoutClass}>
                <div class="min-w-0">
                  <div class="flex flex-wrap items-center gap-2 text-[10px] md:text-[11px] font-semibold uppercase tracking-[0.28em] text-secondary-text">
                    <span>{cat.count} {cat.count === 1 ? "ARTIGO" : "ARTIGOS"}</span>
                  </div>
                  <h3 class="mt-0.5 text-base md:text-lg font-semibold leading-snug text-primary-text ui-transition group-hover:text-primary-text">
                    {cat.label}
                  </h3>
                </div>

                {showThumb && (
                  <div class="shrink-0 ml-2">
                    <img
                      src={cat.heroImage!}
                      alt={cat.label}
                      loading="lazy"
                      decoding="async"
                      class="h-20 w-20 md:h-20 md:w-24 object-cover rounded"
                    />
                  </div>
                )}
              </div>
            </a>
          </li>
        );
      })}
    </ul>
  </section>
</PageLayout>
