---
import PageLayout from "@/layouts/PageLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import { CATEGORY_OPTIONS } from "@/utils/categories";
import PostListItem from "@/components/PostListItem.astro";

// Gera rotas estáticas a partir das opções
export async function getStaticPaths() {
  const posts = await getCollection("blogs");

  return CATEGORY_OPTIONS.map((label) => {
    const items = posts
      .filter((p) => (p.data.category ?? "").toLowerCase() === label.toLowerCase())
      .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

    return { params: { category: label.toLowerCase() }, props: { label, items } };
  });
}

// ----- Fallback robusto: se props não vierem, resolvemos por params -----
type P = { label?: string; items?: CollectionEntry<"blogs">[] };
let { label, items } = Astro.props as P;

if (!label || !items) {
  const slug = (Astro.params?.category ?? "").toString().toLowerCase();
  const allPosts = await getCollection("blogs");

  // tenta achar o label canônico nas opções, senão usa o próprio slug
  label = CATEGORY_OPTIONS.find((opt) => opt.toLowerCase() === slug) ?? slug;

  items = allPosts
    .filter((p) => (p.data.category ?? "").toLowerCase() === slug)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
}
---
<PageLayout>
  <section class="flex flex-col space-y-3 md:space-y-4">
    <!-- rótulo alinhado à mesma régua dos cards -->
    <div class="mx-auto w-full md:max-w-[46rem] lg:max-w-[50rem] xl:max-w-[52rem]">
      <p class="text-[12px] font-semibold uppercase tracking-[0.16em] text-muted-text">
        CATEGORIA # {(label?.toUpperCase() ?? "")}
      </p>
    </div>

    {items && items.length ? (
      <ul class="space-y-3 md:space-y-4">
        {items.map((post) => (
          <li class="py-0 first:pt-0">
            <PostListItem post={post} />
          </li>
        ))}
      </ul>
    ) : (
      <div class="mx-auto w-full md:max-w-[46rem] lg:max-w-[50rem] xl:max-w-[52rem]">
        <p class="text-secondary-text">No posts in this category yet.</p>
      </div>
    )}
  </section>
</PageLayout>
